<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í‚¬ í (Skill Pong)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #1a0033 0%, #0a001a 50%, #000000 100%);
            color: #eee;
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
            overflow-x: hidden;
            overflow-y: auto;
        }
        #app-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        canvas {
            background-color: #000;
            border: 4px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5), 0 0 60px rgba(255, 0, 255, 0.3);
            border-radius: 8px;
            max-width: 100%;
            height: auto;
        }
        #game-container {
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            backdrop-filter: blur(5px);
        }
        h1 {
            font-size: 48px;
            text-shadow: 3px 3px 0px #ff00ff, -3px -3px 0px #00ffff;
            animation: pulse 2s ease-in-out infinite;
        }
        h1, h2 { font-family: 'Orbitron', 'Noto Sans KR', sans-serif; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes gachaReveal {
            0% {
                opacity: 0;
                transform: scale(0.3) rotateY(180deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.1) rotateY(90deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }
        h2 {
            font-size: 24px;
            margin: 20px 0;
            color: #00ffff;
        }
        p {
            font-size: 14px;
            margin: 10px 0;
            line-height: 1.6;
        }
        .character-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
            max-width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: #00ffff #1a1a2e;
        }
        .character-selection::-webkit-scrollbar {
            width: 8px;
        }
        .character-selection::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 4px;
        }
        .character-selection::-webkit-scrollbar-thumb {
            background: #00ffff;
            border-radius: 4px;
        }
        .char-card {
            border: 3px solid #fff;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            min-height: 150px;
        }
        .char-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .char-card:hover::before {
            left: 100%;
        }
        .char-card:hover {
            background: rgba(40, 40, 80, 0.8);
            transform: scale(1.08) translateY(-5px);
            border-color: #00ffff;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.5);
        }
        .char-card.selected {
            border-color: #ffff00;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.6);
            transform: scale(1.04);
        }
        .char-card h3 {
            margin: 0 0 10px 0;
            color: #ff00ff;
            font-size: 14px;
        }
        .char-card p {
            font-size: 11px;
            color: #ccc;
            line-height: 1.4;
        }
        .char-card strong {
            color: #00ffff;
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        #restart-button {
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(135deg, #ff00ff, #ff0080);
            color: #fff;
            border: 3px solid #fff;
            cursor: pointer;
            margin-top: 30px;
            border-radius: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.5);
        }
        #restart-button:hover {
            background: linear-gradient(135deg, #c000c0, #c00060);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 0, 255, 0.7);
        }
        #restart-button:active {
            transform: translateY(-1px);
        }
        .score-popup {
            position: absolute;
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            animation: scoreFloat 1s ease-out forwards;
            pointer-events: none;
        }
        @keyframes scoreFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }
        .game-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 2px solid #333;
        }
        .screen {
            display: none;
            width: 100%;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #main-menu-screen {
            padding: 20px;
        }
        #gacha-screen {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .button {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #00ffff, #00aaff);
            color: #000;
            border: 3px solid #00ffff;
            cursor: pointer;
            margin: 10px;
            border-radius: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4);
            font-family: 'Orbitron', 'Noto Sans KR', sans-serif;
        }
        .button:hover {
            background: linear-gradient(135deg, #00aaff, #0088dd);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 255, 255, 0.6);
        }
        .button:active {
            transform: translateY(-1px);
        }
        .button.secondary {
            background: linear-gradient(135deg, #ff00ff, #ff0080);
            border-color: #ff00ff;
            box-shadow: 0 5px 20px rgba(255, 0, 255, 0.4);
        }
        .button.secondary:hover {
            background: linear-gradient(135deg, #dd00dd, #dd0060);
            box-shadow: 0 8px 30px rgba(255, 0, 255, 0.6);
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        #currency-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            z-index: 1000;
        }
        #gacha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #gacha-modal.active {
            display: flex;
        }
        .gacha-card {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 5px solid #fff;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: gachaReveal 1.5s ease-out;
            box-shadow: 0 0 100px rgba(255, 255, 255, 0.5);
            max-width: 500px;
        }
        @keyframes gachaReveal {
            0% {
                opacity: 0;
                transform: scale(0.5) rotateY(180deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.1) rotateY(90deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }
        .gacha-card h2 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px currentColor;
        }
        .gacha-card .skin-name {
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
        }
        .gacha-card .rarity {
            font-size: 20px;
            margin: 10px 0;
            font-weight: 600;
        }
        .rarity-common { color: #9e9e9e; }
        .rarity-rare { color: #4dabf7; }
        .rarity-epic { color: #9775fa; }
        .rarity-legendary { color: #ffd43b; }
        .gacha-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }
        .skin-item {
            background: rgba(20, 20, 40, 0.8);
            border: 3px solid #444;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .skin-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3);
        }
        .skin-item.equipped {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }
    </style>
    <!-- êµ¬ê¸€ í°íŠ¸ ë³€ê²½: Noto Sans KR + Orbitron -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <!-- UI ì˜¤ë²„ë ˆì´ -->
    <div id="ui-overlay">
        <!-- ìºë¦­í„° ì„ íƒ í™”ë©´ -->
        <div id="character-select-screen">
            <h1>ìŠ¤í‚¬ í</h1>
            <p>ë§ˆìš°ìŠ¤ë¡œ íŒ¨ë“¤ì„ ì›€ì§ì´ê³ , ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ìŠ¤í‚¬ì„ ì‚¬ìš©í•˜ì„¸ìš”!</p>
            <h2>ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <div class="character-selection">
                <div class="char-card" data-char="speedster">
                    <h3>âš¡ ìŠ¤í”¼ë“œìŠ¤í„°</h3>
                    <p><strong>ìŠ¤í‚¬: ë¶€ìŠ¤íŠ¸</strong><br>5ì´ˆê°„ íŒ¨ë“¤ì˜ ì´ë™ ì†ë„ê°€ 2.5ë°° ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="guardian">
                    <h3>ğŸ›¡ï¸ ê°€ë””ì–¸</h3>
                    <p><strong>ìŠ¤í‚¬: ë°©ë²½</strong><br>5ì´ˆê°„ íŒ¨ë“¤ì˜ ê¸¸ì´ê°€ 2ë°°ë¡œ ëŠ˜ì–´ë‚˜ ë°©ì–´ì— ìœ ë¦¬í•´ì§‘ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="phantom">
                    <h3>ğŸ‘» íŒ¬í…€</h3>
                    <p><strong>ìŠ¤í‚¬: ìœ ë ¹ ê³µ</strong><br>3ì´ˆê°„ ê³µì´ ë°˜íˆ¬ëª…í•´ì ¸ ìƒëŒ€ë°©ì„ êµë€ì‹œí‚µë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="sniper">
                    <h3>ğŸ¯ ìŠ¤ë‚˜ì´í¼</h3>
                    <p><strong>ìŠ¤í‚¬: ì •ë°€ íƒ€ê²©</strong><br>4ì´ˆê°„ ê³µì˜ ì†ë„ê°€ 2ë°° ë¹¨ë¼ì§‘ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="berserker">
                    <h3>âš”ï¸ ë²„ì„œì»¤</h3>
                    <p><strong>ìŠ¤í‚¬: ê´‘í­í™”</strong><br>6ì´ˆê°„ ê³µì˜ í¬ê¸°ê°€ ì‘ì•„ì§€ì§€ë§Œ ì†ë„ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="timekeeper">
                    <h3>â° íƒ€ì„í‚¤í¼</h3>
                    <p><strong>ìŠ¤í‚¬: ì‹œê°„ ì •ì§€</strong><br>2ì´ˆê°„ ê³µì˜ ì†ë„ê°€ 70% ê°ì†Œí•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="frost">
                    <h3>â„ï¸ í”„ë¡œìŠ¤íŠ¸</h3>
                    <p><strong>ìŠ¤í‚¬: ë¹™ê²°</strong><br>4ì´ˆê°„ ìƒëŒ€ì˜ ì´ë™/ë°˜ì‘ ì†ë„ë¥¼ ì ˆë°˜ìœ¼ë¡œ ë‘”í™”ì‹œí‚µë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="giant">
                    <h3>ğŸ—¿ ìì´ì–¸íŠ¸</h3>
                    <p><strong>ìŠ¤í‚¬: ê±°ëŒ€í™”</strong><br>5ì´ˆê°„ íŒ¨ë“¤ì˜ ë„ˆë¹„ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="mystic">
                    <h3>ğŸ”® ë¯¸ìŠ¤í‹±</h3>
                    <p><strong>ìŠ¤í‚¬: ì‹ ë¹„í•œ ë°©ì–´</strong><br>4ì´ˆê°„ íŒ¨ë“¤ì˜ ë†’ì´ê°€ 1.5ë°° ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="blade">
                    <h3>ğŸ—¡ï¸ ë¸”ë ˆì´ë“œ</h3>
                    <p><strong>ìŠ¤í‚¬: ì˜ˆë¦¬í•œ ë°˜ê²©</strong><br>3ì´ˆê°„ ê³µì˜ ì†ë„ê°€ 30% ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="thunder">
                    <h3>âš¡ ì¬ë”</h3>
                    <p><strong>ìŠ¤í‚¬: ì „ê²© í˜¼ë€</strong><br>3.5ì´ˆê°„ ê³µì´ ì§€ê·¸ì¬ê·¸ë¡œ ì›€ì§ì´ë©° ì†ë„ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="shadow">
                    <h3>ğŸŒ‘ ì„€ë„ìš°</h3>
                    <p><strong>ìŠ¤í‚¬: ì€ì‹ </strong><br>4ì´ˆê°„ ìì‹ ì˜ íŒ¨ë“¤ì´ íˆ¬ëª…í•´ì§€ê³  ì´ë™ ì†ë„ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="char-card" data-char="phoenix">
                    <h3>ğŸ”¥ í”¼ë‹‰ìŠ¤</h3>
                    <p><strong>ìŠ¤í‚¬: ë¶ˆì‚¬ì¡°ì˜ ë‚ ê°œ</strong><br>2.5ì´ˆê°„ ê³µì´ í™”ì—¼ ê¶¤ì ì„ ë‚¨ê¸°ë©° ì†ë„ê°€ 80% ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 30px;">
                <button class="button secondary" onclick="showGachaScreen()" style="padding: 12px 30px; font-size: 16px;">âœ¨ ê°€ì± </button>
                <button class="button secondary" onclick="showSkinScreen()" style="padding: 12px 30px; font-size: 16px;">ğŸ‘• ìŠ¤í‚¨ ì¥ì°©</button>
            </div>
        </div>
        
        <!-- ê°€ì±  í™”ë©´ -->
        <div id="gacha-screen" style="display: none;">
            <h1 style="margin-bottom: 30px;">âœ¨ ìŠ¤í‚¨ ê°€ì±  âœ¨</h1>
            <p style="font-size: 16px; margin: 20px 0; color: #ccc;">ìŠ¤í‚¨ì„ íšë“í•˜ì—¬ ê²Œì„ ë°°ê²½ê³¼ íš¨ê³¼ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•˜ì„¸ìš”!</p>
            
            <div style="background: rgba(0,0,0,0.6); border: 2px solid #444; border-radius: 12px; padding: 20px; margin: 30px auto; max-width: 500px;">
                <div style="font-size: 18px; margin-bottom: 20px;">
                    <strong style="color: #ffd700;">ë³´ìœ  ì½”ì¸:</strong> <span style="color: #ffd700; font-size: 24px; font-weight: bold;" id="gacha-coin-display">0</span> ğŸ’°
                </div>
                <button onclick="performGachaFromScreen()" style="
                    width: 100%;
                    padding: 20px;
                    font-size: 20px;
                    font-weight: 600;
                    background: linear-gradient(135deg, #ff00ff, #ff0080);
                    color: #fff;
                    border: 3px solid #ff00ff;
                    cursor: pointer;
                    border-radius: 10px;
                    transition: all 0.3s;
                    box-shadow: 0 5px 20px rgba(255, 0, 255, 0.5);
                    font-family: `"Orbitron`", `"Noto Sans KR`", sans-serif;
                ">ğŸ² 1íšŒ ë½‘ê¸° (100 ì½”ì¸)</button>
            </div>
            
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; color: #00ffff;">í™•ë¥  ì •ë³´</h2>
                <div style="background: rgba(0,0,0,0.5); border: 2px solid #333; border-radius: 10px; padding: 20px; max-width: 400px; margin: 0 auto;">
                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9e9e9e;">âšª ì»¤ë¨¼ (Common)</span>
                        <strong style="color: #9e9e9e;">65%</strong>
                    </div>
                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #4dabf7;">ğŸ”µ ë ˆì–´ (Rare)</span>
                        <strong style="color: #4dabf7;">25%</strong>
                    </div>
                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9775fa;">ğŸŸ£ ì—í”½ (Epic)</span>
                        <strong style="color: #9775fa;">9%</strong>
                    </div>
                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ffd43b;">ğŸŸ¡ ë ˆì „ë”ë¦¬ (Legendary)</span>
                        <strong style="color: #ffd43b;">1%</strong>
                    </div>
                </div>
            </div>
            
            <button onclick="hideGachaScreen()" style="
                margin-top: 40px;
                padding: 15px 40px;
                font-size: 18px;
                background: linear-gradient(135deg, #00ffff, #00aaff);
                color: #000;
                border: 3px solid #00ffff;
                cursor: pointer;
                border-radius: 8px;
                font-weight: 600;
                font-family: `"Orbitron`", `"Noto Sans KR`", sans-serif;
            ">ë’¤ë¡œ ê°€ê¸°</button>
        </div>
        
        <!-- ìŠ¤í‚¨ ì¥ì°© í™”ë©´ -->
        <div id="skin-screen" style="display: none;">
            <h1 style="margin-bottom: 30px;">ğŸ‘• ìŠ¤í‚¨ ì¥ì°©</h1>
            <p style="font-size: 16px; margin: 20px 0; color: #ccc;">ë³´ìœ í•œ ìŠ¤í‚¨ì„ ì„ íƒí•˜ì—¬ ì¥ì°©í•˜ì„¸ìš”!</p>
            
            <div id="skin-list-container" style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
                margin: 30px 0;
                max-height: 60vh;
                overflow-y: auto;
                padding: 10px;
            ">
                <!-- ìŠ¤í‚¨ ëª©ë¡ì´ JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </div>
            
            <button onclick="hideSkinScreen()" style="
                margin-top: 30px;
                padding: 15px 40px;
                font-size: 18px;
                background: linear-gradient(135deg, #00ffff, #00aaff);
                color: #000;
                border: 3px solid #00ffff;
                cursor: pointer;
                border-radius: 8px;
                font-weight: 600;
                font-family: `"Orbitron`", `"Noto Sans KR`", sans-serif;
            ">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
        <div id="game-over-screen" style="display: none;">
            <h1 id="winner-message">ê²Œì„ ì˜¤ë²„</h1>
            <div style="margin: 20px 0; font-size: 18px;">
                <p id="final-score"></p>
                <p id="rank-info"></p>
            </div>
            <button id="restart-button">ë‹¤ì‹œ ì‹œì‘</button>
        </div>

        <!-- ìŠ¤í‚¨/ê°€ì±  íŒ¨ë„ (ê²Œì„ í™”ë©´ì—ë§Œ í‘œì‹œ) -->
        <div id="skins-panel" style="display: none; position:fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); border:3px solid #00ffff; border-radius:12px; padding:15px; max-width:350px; z-index: 100;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px;">
                <strong style="color:#00ffff; font-size: 16px;">ìŠ¤í‚¨</strong>
                <button id="gacha-button" style="padding:10px 16px; border:3px solid #ff00ff; background:#111; color:#fff; cursor:pointer; font-family: 'Orbitron', 'Noto Sans KR', sans-serif; border-radius: 6px; font-weight: 600;">ê°€ì±  (100ğŸ’°)</button>
            </div>
            <div id="skins-inventory" style="margin-top:10px; text-align:left; max-height:150px; overflow:auto; font-size:13px;"></div>
            <div id="skins-info" style="margin-top:8px; font-size:11px; color:#999;">ìŠ¤í‚¨ì„ í´ë¦­í•˜ì—¬ ì ìš©í•©ë‹ˆë‹¤.</div>
        </div>
        
        <!-- ì½”ì¸ ë””ìŠ¤í”Œë ˆì´ -->
        <div id="coin-display" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 3px solid #ffd700; border-radius: 10px; padding: 12px 24px; font-size: 22px; font-weight: bold; color: #ffd700; z-index: 1000; font-family: 'Orbitron', sans-serif; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);">
            ğŸ’° <span id="coin-amount">0</span>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // UI ìš”ì†Œ
    const uiOverlay = document.getElementById('ui-overlay');
    const charSelectScreen = document.getElementById('character-select-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const winnerMessage = document.getElementById('winner-message');
    const restartButton = document.getElementById('restart-button');
    const charCards = document.querySelectorAll('.char-card');
    const skinsInventoryEl = document.getElementById('skins-inventory');
    const gachaButton = document.getElementById('gacha-button');

    // ê²Œì„ ìƒíƒœ
    let gameState = 'menu'; // menu, playing, gameOver, countdown
    let selectedChar = null;
    let aiChar = null;
    let countdownValue = 3;
    const POINTS_TO_WIN = 10; // ë¼ìš´ë“œë‹¹ ì´ê¸°ëŠ”ë° í•„ìš”í•œ ì ìˆ˜ (ê¸¸ê²Œ í”Œë ˆì´)

    // ìŠ¤í‚¨ ì‹œìŠ¤í…œ ìƒíƒœ
    const skins = {
        // rarity: common, rare, epic, legendary
        pool: [
            // Common (ì»¤ë¨¼)
            { id: 'neon-blue', name: 'ë„¤ì˜¨ ë¸”ë£¨', rarity: 'common', theme: { border:'#00ffff', glow:1, bg:'linear-gradient(135deg, #101020, #000010)' }},
            { id: 'neon-pink', name: 'ë„¤ì˜¨ í•‘í¬', rarity: 'common', theme: { border:'#ff00ff', glow:1, bg:'linear-gradient(135deg, #201020, #000010)' }},
            { id: 'forest-green', name: 'í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°', rarity: 'common', theme: { border:'#2ecc71', glow:1, bg:'linear-gradient(135deg, #0d3d0d, #051805)' }},
            { id: 'sunset-orange', name: 'ì„ ì…‹ ì˜¤ë Œì§€', rarity: 'common', theme: { border:'#ff6b35', glow:1, bg:'linear-gradient(135deg, #2d1810, #0a0502)' }},
            { id: 'ocean-blue', name: 'ì˜¤ì…˜ ë¸”ë£¨', rarity: 'common', theme: { border:'#3498db', glow:1, bg:'linear-gradient(135deg, #102838, #050a10)' }},
            
            // Rare (ë ˆì–´)
            { id: 'circuit', name: 'íšŒë¡œ íŒ¨í„´', rarity: 'rare', theme: { border:'#00ff88', glow:1.3, bg:'linear-gradient(135deg, #002018, #001008)' }},
            { id: 'crimson-steel', name: 'í¬ë¦¼ìŠ¨ ìŠ¤í‹¸', rarity: 'rare', theme: { border:'#dc143c', glow:1.3, bg:'linear-gradient(135deg, #2d0a0a, #0d0202)' }},
            { id: 'toxic-waste', name: 'í†¡ì‹œ ì›¨ì´ìŠ¤íŠ¸', rarity: 'rare', theme: { border:'#39ff14', glow:1.4, bg:'radial-gradient(circle at 30% 40%, #1a3a0a, #050a02)' }},
            { id: 'midnight-purple', name: 'ë¯¸ë“œë‚˜ì‡ í¼í”Œ', rarity: 'rare', theme: { border:'#9b59b6', glow:1.3, bg:'linear-gradient(135deg, #1a0a2d, #05020a)' }},
            
            // Epic (ì—í”½)
            { id: 'aurora', name: 'ì˜¤ë¡œë¼', rarity: 'epic', theme: { border:'#88ccff', glow:1.6, bg:'linear-gradient(135deg, #001022, #000012)' }},
            { id: 'inferno', name: 'ì¸í˜ë¥´ë…¸', rarity: 'epic', theme: { border:'#ff4500', glow:1.7, bg:'radial-gradient(circle at 50% 50%, #3d0a00, #0a0000 70%)' }},
            { id: 'cyber-matrix', name: 'ì‚¬ì´ë²„ ë§¤íŠ¸ë¦­ìŠ¤', rarity: 'epic', theme: { border:'#00ff00', glow:1.6, bg:'linear-gradient(45deg, #001a00 0%, #000a00 25%, #001400 50%, #000a00 75%, #001a00 100%)' }},
            
            // Legendary (ë ˆì „ë”ë¦¬)
            { id: 'void', name: 'ë³´ì´ë“œ', rarity: 'legendary', theme: { border:'#ffffff', glow:2.0, bg:'radial-gradient(circle at 20% 30%, #111, #000 60%)' }},
            { id: 'galactic-core', name: 'ê°¤ëŸ­í‹± ì½”ì–´', rarity: 'legendary', theme: { border:'#ffd700', glow:2.2, bg:'radial-gradient(ellipse at center, #1a0033 0%, #4a0080 30%, #0a0015 70%, #000 100%)' }},
            { id: 'divine-light', name: 'ë””ë°”ì¸ ë¼ì´íŠ¸', rarity: 'legendary', theme: { border:'#ffffcc', glow:2.5, bg:'radial-gradient(circle at 50% 30%, #fff9e6, #ffe6b3 20%, #ffcc80 40%, #1a1a0d 80%)' }}
        ],
        weights: { common: 0.65, rare: 0.25, epic: 0.09, legendary: 0.01 },
        owned: [],
        equipped: null
    };

    function loadSkins() {
        try {
            const data = JSON.parse(localStorage.getItem('skillPongSkins') || '{}');
            if (Array.isArray(data.owned)) skins.owned = data.owned; else skins.owned = [];
            skins.equipped = data.equipped || null;
        } catch { skins.owned = []; skins.equipped = null; }
        renderSkins();
        applyEquippedSkin();
    }

    function saveSkins() {
        localStorage.setItem('skillPongSkins', JSON.stringify({ owned: skins.owned, equipped: skins.equipped }));
    }
    
    // ì¬í™” ë° ì§„í–‰ë„ ì €ì¥/ë¡œë“œ
    function saveCurrency() {
        localStorage.setItem('skillPongProgress', JSON.stringify({
            coins: currency.coins,
            totalScore: rankSystem.totalScore,
            roundsPlayed: rankSystem.roundsPlayed,
            unlockedChars: characterUnlock.unlocked
        }));
    }
    
    function loadCurrency() {
        try {
            const data = JSON.parse(localStorage.getItem('skillPongProgress') || '{}');
            currency.coins = data.coins || 0;
            rankSystem.totalScore = data.totalScore || 0;
            rankSystem.roundsPlayed = data.roundsPlayed || 0;
            if (Array.isArray(data.unlockedChars)) {
                characterUnlock.unlocked = data.unlockedChars;
            }
        } catch {
            currency.coins = 0;
            rankSystem.totalScore = 0;
            rankSystem.roundsPlayed = 0;
        }
    }
    
    // ìºë¦­í„° í•´ê¸ˆ ì²´í¬
    function checkCharacterUnlocks() {
        let unlocked = false;
        for (const [charId, required] of Object.entries(characterUnlock.requirements)) {
            if (!characterUnlock.unlocked.includes(charId) && rankSystem.totalScore >= required) {
                characterUnlock.unlocked.push(charId);
                unlocked = true;
                alert(`ğŸ‰ ìƒˆ ìºë¦­í„° í•´ê¸ˆ: ${characters[charId].name}!`);
            }
        }
        if (unlocked) {
            saveCurrency();
            updateCharacterCards();
        }
    }
    
    // ìºë¦­í„° ì¹´ë“œ UI ì—…ë°ì´íŠ¸ (ì ê¸ˆ/í•´ê¸ˆ í‘œì‹œ)
    function updateCharacterCards() {
        charCards.forEach(card => {
            const charId = card.dataset.char;
            const isUnlocked = characterUnlock.unlocked.includes(charId);
            
            if (!isUnlocked) {
                card.style.opacity = '0.5';
                card.style.filter = 'grayscale(0.8)';
                const required = characterUnlock.requirements[charId];
                const lockInfo = card.querySelector('.lock-info');
                if (!lockInfo) {
                    const info = document.createElement('div');
                    info.className = 'lock-info';
                    info.style.cssText = 'position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); padding:3px 6px; border-radius:4px; font-size:10px;';
                    info.textContent = `ğŸ”’ ${required}ì `;
                    card.appendChild(info);
                }
            } else {
                card.style.opacity = '1';
                card.style.filter = 'none';
                const lockInfo = card.querySelector('.lock-info');
                if (lockInfo) lockInfo.remove();
            }
        });
    }

    function renderSkins() {
        if (!skinsInventoryEl) return;
        if (!skins.owned.length) {
            skinsInventoryEl.innerHTML = '<em>ë³´ìœ  ìŠ¤í‚¨ì´ ì—†ìŠµë‹ˆë‹¤. ê°€ì± ë¡œ ìŠ¤í‚¨ì„ ë½‘ì•„ë³´ì„¸ìš”.</em>';
            return;
        }
        const rarityColors = {
            common: '#9e9e9e',
            rare: '#4dabf7',
            epic: '#9775fa',
            legendary: '#ffd43b'
        };
        const rarityIcons = {
            common: 'âšª',
            rare: 'ğŸ”µ',
            epic: 'ğŸŸ£',
            legendary: 'ğŸŸ¡'
        };
        skinsInventoryEl.innerHTML = skins.owned.map(id => {
            const s = skins.pool.find(p => p.id === id);
            const mark = skins.equipped === id ? ' âœ“' : '';
            const rarityColor = s ? rarityColors[s.rarity] : '#fff';
            const rarityIcon = s ? rarityIcons[s.rarity] : '';
            const rarityText = s ? s.rarity.toUpperCase() : '';
            return `<div data-skin="${id}" style="cursor:pointer; padding:4px 6px; border-bottom:1px solid #333; border-left:3px solid ${rarityColor}; background: ${skins.equipped === id ? 'rgba(255,255,255,0.1)' : 'transparent'};">
                <span style="color:${rarityColor};">${rarityIcon}</span> <strong>${s ? s.name : id}</strong> <span style="color:${rarityColor}; font-size:9px;">[${rarityText}]</span>${mark}
            </div>`;
        }).join('');
        skinsInventoryEl.querySelectorAll('[data-skin]').forEach(el => {
            el.onclick = () => {
                const id = el.getAttribute('data-skin');
                skins.equipped = id;
                saveSkins();
                renderSkins();
                applyEquippedSkin();
            };
        });
    }

    function rollRarity() {
        const r = Math.random();
        let acc = 0;
        for (const [rar, w] of Object.entries(skins.weights)) {
            acc += w; if (r < acc) return rar;
        }
        return 'common';
    }

    function gachaOnce() {
        const cost = 100;
        if (currency.coins < cost) {
            alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: 100)');
            return;
        }
        currency.coins -= cost;
        saveCurrency();
        updateCoinDisplay();
        
        const rarity = rollRarity();
        const candidates = skins.pool.filter(s => s.rarity === rarity);
        const picked = candidates[Math.floor(Math.random() * candidates.length)];
        
        // ì¤‘ë³µ í—ˆìš©: ë‹¨, ì¸ë²¤í† ë¦¬ì— ê¸°ë¡ì€ ê³„ì† ë³´ê´€(ì¤‘ë³µ í‘œì‹œ)
        skins.owned.push(picked.id);
        saveSkins();
        
        // ê°€ì±  ì• ë‹ˆë©”ì´ì…˜ ëª¨ë‹¬ í‘œì‹œ
        showGachaAnimation(picked, rarity);
    }
    
    function showGachaAnimation(skin, rarity) {
        // ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        `;
        
        const rarityColors = {
            common: '#9e9e9e',
            rare: '#4dabf7',
            epic: '#9775fa',
            legendary: '#ffd43b'
        };
        
        const card = document.createElement('div');
        card.style.cssText = `
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 5px solid ${rarityColors[rarity]};
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            animation: gachaReveal 1.5s ease-out;
            box-shadow: 0 0 100px ${rarityColors[rarity]};
            max-width: 500px;
        `;
        
        card.innerHTML = `
            <h2 style="font-size: 48px; margin-bottom: 30px; color: ${rarityColors[rarity]}; text-shadow: 0 0 30px ${rarityColors[rarity]}; animation: pulse 2s ease-in-out infinite;">
                âœ¨ ìŠ¤í‚¨ íšë“! âœ¨
            </h2>
            <div style="font-size: 24px; font-weight: 600; color: ${rarityColors[rarity]}; margin: 15px 0;">
                ${rarity.toUpperCase()}
            </div>
            <div style="font-size: 36px; font-weight: bold; margin: 30px 0; color: #fff;">
                ${skin.name}
            </div>
            <p style="margin: 25px 0; font-size: 16px; color: #ccc;">
                ìŠ¤í‚¨ì´ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!
            </p>
            <button onclick="this.parentElement.parentElement.remove(); renderSkins();" style="
                padding: 15px 40px;
                font-size: 18px;
                background: linear-gradient(135deg, #00ffff, #00aaff);
                color: #000;
                border: 3px solid #00ffff;
                cursor: pointer;
                border-radius: 8px;
                font-weight: 600;
                margin-top: 20px;
            ">í™•ì¸</button>
        `;
        
        modal.appendChild(card);
        document.body.appendChild(modal);
        
        // 3ì´ˆ í›„ ìë™ ë‹«ê¸° (ì„ íƒì‚¬í•­)
        setTimeout(() => {
            if (modal.parentElement) {
                modal.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    modal.remove();
                    renderSkins();
                }, 300);
            }
        }, 5000);
    }

    function applyEquippedSkin() {
        const id = skins.equipped;
        const skin = skins.pool.find(s => s.id === id);
        const container = document.getElementById('gameCanvas');
        if (!skin || !container) { document.body.style.background = 'linear-gradient(135deg, #1a0033 0%, #0a001a 50%, #000000 100%)'; return; }
        document.body.style.background = skin.theme.bg || document.body.style.background;
        container.style.borderColor = skin.theme.border || '#00ffff';
        // ê¸€ë¡œìš° ê°•ë„ëŠ” draw ë‹¨ê³„ì—ì„œ ê³±ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì €ì¥í•´ë‘ 
        window.__skinGlowScale = skin.theme.glow || 1;
    }

    if (gachaButton) {
        gachaButton.addEventListener('click', () => {
            gachaOnce();
        });
    }

    // ë­í¬ ì‹œìŠ¤í…œ (ëˆ„ì  ì ìˆ˜ ê¸°ë°˜)
    const rankSystem = {
        totalScore: 0,
        roundsPlayed: 0,
        rankNames: ['ë¸Œë¡ ì¦ˆ V', 'ë¸Œë¡ ì¦ˆ IV', 'ë¸Œë¡ ì¦ˆ III', 'ë¸Œë¡ ì¦ˆ II', 'ë¸Œë¡ ì¦ˆ I',
                    'ì‹¤ë²„ V', 'ì‹¤ë²„ IV', 'ì‹¤ë²„ III', 'ì‹¤ë²„ II', 'ì‹¤ë²„ I',
                    'ê³¨ë“œ V', 'ê³¨ë“œ IV', 'ê³¨ë“œ III', 'ê³¨ë“œ II', 'ê³¨ë“œ I',
                    'í”Œë˜í‹°ë„˜ V', 'í”Œë˜í‹°ë„˜ IV', 'í”Œë˜í‹°ë„˜ III', 'í”Œë˜í‹°ë„˜ II', 'í”Œë˜í‹°ë„˜ I',
                    'ë‹¤ì´ì•„ëª¬ë“œ V', 'ë‹¤ì´ì•„ëª¬ë“œ IV', 'ë‹¤ì´ì•„ëª¬ë“œ III', 'ë‹¤ì´ì•„ëª¬ë“œ II', 'ë‹¤ì´ì•„ëª¬ë“œ I',
                    'ë§ˆìŠ¤í„°', 'ê·¸ëœë“œë§ˆìŠ¤í„°', 'ì±Œë¦°ì €'],
        tierThresholds: [0, 50, 120, 200, 300, 420, 560, 720, 900, 1100, 1320, 1560, 1820, 2100, 2400, 2720, 3060, 3420, 3800, 4200, 4620, 5060, 5520, 6000, 6500, 7020, 7560, 8200]
    };
    
    // ì¬í™” ì‹œìŠ¤í…œ
    const currency = {
        coins: 0
    };
    
    // ìºë¦­í„° í•´ê¸ˆ ì‹œìŠ¤í…œ
    const characterUnlock = {
        unlocked: ['speedster'], // ê¸°ë³¸ ìºë¦­í„°
        requirements: {
            speedster: 0,
            guardian: 5,
            phantom: 15,
            sniper: 30,
            berserker: 50,
            timekeeper: 80,
            frost: 120,
            giant: 180,
            mystic: 250,
            blade: 350,
            thunder: 480,
            shadow: 650,
            phoenix: 900
        }
    };

    // ì ìˆ˜ ì‹œìŠ¤í…œ (ì½¤ë³´ ì œê±°)
    const scoreSystem = {
        lastScorer: null
    };

    // ê²Œì„ ê°ì²´
    const ball = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 10,
        baseRadius: 10,
        speed: 4.5,
        baseSpeed: 4.5,
        speedX: 3,
        speedY: 3,
        color: '#eee',
        alpha: 1.0
    };

    const player = {
        x: 10,
        y: (canvas.height - 100) / 2,
        width: 10,
        height: 100,
        baseHeight: 100,
        score: 0,
        speed: 8,
        baseSpeed: 8,
        color: '#00ffff',
        character: null
    };
    // ë§ˆìš°ìŠ¤ ëª©í‘œ ìœ„ì¹˜ ê¸°ë°˜ ì´ë™ì„ ìœ„í•œ íƒ€ê¹ƒ Y
    let playerTargetY = (canvas.height - 100) / 2;

    const ai = {
        x: canvas.width - 20,
        y: (canvas.height - 100) / 2,
        width: 10,
        height: 100,
        baseHeight: 100,
        score: 0,
        speed: 3, // ì´ˆê¸° ì†ë„ë¥¼ ë§¤ìš° ì•½í•˜ê²Œ ì„¤ì •
        baseSpeed: 3,
        color: '#ff00ff',
        character: null,
        reactionSpeed: 0.03 // ì´ˆê¸° ë°˜ì‘ì†ë„ë¥¼ ë§¤ìš° ë‚®ê²Œ
    };
    
    // ìŠ¤í‚¬ ê´€ë ¨ ë³€ìˆ˜
    const skill = {
        player: {
            cooldown: 15000,
            duration: 5000,
            lastUsed: 0,
            isActive: false
        },
        ai: {
            cooldown: 18000, // AIëŠ” ì•½ê°„ ë” ê¸´ ì¿¨ë‹¤ìš´
            duration: 5000,
            lastUsed: 0,
            isActive: false
        }
    };

    // ì¼ì‹œì ì¸ ë””ë²„í”„/ë²„í”„ ìƒíƒœ ì €ì¥ (í”„ë¡œìŠ¤íŠ¸ ë“±)
    const tempState = {
        aiPrevSpeed: null,
        aiPrevReaction: null,
        playerPrevSpeed: null,
        playerPrevReaction: null
    };

    // ìºë¦­í„° ì •ì˜
    const characters = {
        speedster: {
            name: 'ìŠ¤í”¼ë“œìŠ¤í„°',
            color: '#00ffff',
            activatePlayer: () => {
                player.speed = player.baseSpeed * 2.5;
                skill.player.duration = 5000;
            },
            deactivatePlayer: () => {
                player.speed = player.baseSpeed;
            },
            activateAI: () => {
                ai.speed = ai.baseSpeed * 2.5;
                skill.ai.duration = 5000;
            },
            deactivateAI: () => {
                ai.speed = ai.baseSpeed;
            }
        },
        guardian: {
            name: 'ê°€ë””ì–¸',
            color: '#ffff00',
            activatePlayer: () => {
                player.height = player.baseHeight * 2;
                skill.player.duration = 5000;
            },
            deactivatePlayer: () => {
                player.height = player.baseHeight;
            },
            activateAI: () => {
                ai.height = ai.baseHeight * 2;
                skill.ai.duration = 5000;
            },
            deactivateAI: () => {
                ai.height = ai.baseHeight;
            }
        },
        phantom: {
            name: 'íŒ¬í…€',
            color: '#9933ff',
            activatePlayer: () => {
                ball.alpha = 0.08; // ê±°ì˜ ì•ˆë³´ì´ê²Œ
                // ê³µ ì´ë™ì— ì•½ê°„ì˜ ëœë¤ ì›Œë¸” ì¶”ê°€ë¡œ í˜¼ë€ ì—°ì¶œ
                window.__phantomActive = true;
                skill.player.duration = 3000;
            },
            deactivatePlayer: () => {
                ball.alpha = 1.0;
                window.__phantomActive = false;
            },
            activateAI: () => {
                ball.alpha = 0.08; // ê±°ì˜ ì•ˆë³´ì´ê²Œ (AIë„ ì‚¬ìš© ì‹œ ë™ì¼)
                window.__phantomActive = true;
                skill.ai.duration = 3000;
            },
            deactivateAI: () => {
                ball.alpha = 1.0;
                window.__phantomActive = false;
            }
        },
        sniper: {
            name: 'ìŠ¤ë‚˜ì´í¼',
            color: '#ff6600',
            activatePlayer: () => {
                ball.speed = ball.baseSpeed * 2;
                skill.player.duration = 4000;
            },
            deactivatePlayer: () => {
                ball.speed = ball.baseSpeed;
            },
            activateAI: () => {
                ball.speed = ball.baseSpeed * 2;
                skill.ai.duration = 4000;
            },
            deactivateAI: () => {
                ball.speed = ball.baseSpeed;
            }
        },
        berserker: {
            name: 'ë²„ì„œì»¤',
            color: '#ff0000',
            activatePlayer: () => {
                ball.radius = ball.baseRadius * 0.6;
                ball.speed = ball.baseSpeed * 1.5;
                skill.player.duration = 6000;
            },
            deactivatePlayer: () => {
                ball.radius = ball.baseRadius;
                ball.speed = ball.baseSpeed;
            },
            activateAI: () => {
                ball.radius = ball.baseRadius * 0.6;
                ball.speed = ball.baseSpeed * 1.5;
                skill.ai.duration = 6000;
            },
            deactivateAI: () => {
                ball.radius = ball.baseRadius;
                ball.speed = ball.baseSpeed;
            }
        },
        timekeeper: {
            name: 'íƒ€ì„í‚¤í¼',
            color: '#00ff99',
            activatePlayer: () => {
                ball.speed = ball.baseSpeed * 0.3;
                skill.player.duration = 2000;
            },
            deactivatePlayer: () => {
                ball.speed = ball.baseSpeed;
            },
            activateAI: () => {
                ball.speed = ball.baseSpeed * 0.3;
                skill.ai.duration = 2000;
            },
            deactivateAI: () => {
                ball.speed = ball.baseSpeed;
            }
        },
        frost: {
            name: 'í”„ë¡œìŠ¤íŠ¸',
            color: '#66ccff',
            activatePlayer: () => {
                // ìƒëŒ€(AI) ë‘”í™”
                if (tempState.aiPrevSpeed === null) tempState.aiPrevSpeed = ai.baseSpeed;
                if (tempState.aiPrevReaction === null) tempState.aiPrevReaction = ai.reactionSpeed;
                ai.baseSpeed *= 0.5;
                ai.speed = ai.baseSpeed;
                ai.reactionSpeed *= 0.5;
                skill.player.duration = 4000;
            },
            deactivatePlayer: () => {
                if (tempState.aiPrevSpeed !== null) {
                    ai.baseSpeed = tempState.aiPrevSpeed; ai.speed = ai.baseSpeed; tempState.aiPrevSpeed = null;
                }
                if (tempState.aiPrevReaction !== null) {
                    ai.reactionSpeed = tempState.aiPrevReaction; tempState.aiPrevReaction = null;
                }
            },
            activateAI: () => {
                // í”Œë ˆì´ì–´ ë‘”í™” (íŒ¨ë“¤ ì´ë™ ì†ë„)
                if (tempState.playerPrevSpeed === null) tempState.playerPrevSpeed = player.baseSpeed;
                player.baseSpeed *= 0.5;
                player.speed = player.baseSpeed;
                skill.ai.duration = 4000;
            },
            deactivateAI: () => {
                if (tempState.playerPrevSpeed !== null) {
                    player.baseSpeed = tempState.playerPrevSpeed; player.speed = player.baseSpeed; tempState.playerPrevSpeed = null;
                }
            }
        },
        giant: {
            name: 'ìì´ì–¸íŠ¸',
            color: '#ffaa00',
            activatePlayer: () => {
                player.width = 18;
                skill.player.duration = 5000;
            },
            deactivatePlayer: () => {
                player.width = 10;
            },
            activateAI: () => {
                ai.width = 18;
                ai.x = canvas.width - ai.width - 10; // ì˜¤ë¥¸ìª½ ì—¬ë°± ìœ ì§€
                skill.ai.duration = 5000;
            },
            deactivateAI: () => {
                ai.width = 10;
                ai.x = canvas.width - ai.width - 10;
            }
        },
        mystic: {
            name: 'ë¯¸ìŠ¤í‹±',
            color: '#bb86fc',
            activatePlayer: () => {
                // íŒ¨ë“¤ ë†’ì´ 1.5ë°° ì¦ê°€
                player.height = player.baseHeight * 1.5;
                skill.player.duration = 4000;
            },
            deactivatePlayer: () => {
                player.height = player.baseHeight;
            },
            activateAI: () => {
                ai.height = ai.baseHeight * 1.5;
                skill.ai.duration = 4000;
            },
            deactivateAI: () => {
                ai.height = ai.baseHeight;
            }
        },
        blade: {
            name: 'ë¸”ë ˆì´ë“œ',
            color: '#cf6679',
            activatePlayer: () => {
                // ê³µì˜ ë°˜ì‚¬ ê°ë„ê°€ ë”ìš± ë‚ ì¹´ë¡­ê²Œ (ì†ë„ë„ ì¼ì‹œì ìœ¼ë¡œ ì¦ê°€)
                ball.speed = ball.speed * 1.3;
                skill.player.duration = 3000;
            },
            deactivatePlayer: () => {
                ball.speed = ball.speed / 1.3;
            },
            activateAI: () => {
                ball.speed = ball.speed * 1.3;
                skill.ai.duration = 3000;
            },
            deactivateAI: () => {
                ball.speed = ball.speed / 1.3;
            }
        },
        thunder: {
            name: 'ì¬ë”',
            color: '#ffeb3b',
            activatePlayer: () => {
                // ê³µì´ ì§€ê·¸ì¬ê·¸ë¡œ ì›€ì§ì„ + ì•½ê°„ ë¹¨ë¼ì§
                window.__thunderActive = true;
                ball.speed = ball.speed * 1.2;
                skill.player.duration = 3500;
            },
            deactivatePlayer: () => {
                window.__thunderActive = false;
                ball.speed = ball.speed / 1.2;
            },
            activateAI: () => {
                window.__thunderActive = true;
                ball.speed = ball.speed * 1.2;
                skill.ai.duration = 3500;
            },
            deactivateAI: () => {
                window.__thunderActive = false;
                ball.speed = ball.speed / 1.2;
            }
        },
        shadow: {
            name: 'ì„€ë„ìš°',
            color: '#424242',
            activatePlayer: () => {
                // ìì‹ ì˜ íŒ¨ë“¤ íˆ¬ëª…í™” + ì†ë„ ì¦ê°€
                window.__shadowPlayerActive = true;
                player.speed = player.baseSpeed * 1.5;
                skill.player.duration = 4000;
            },
            deactivatePlayer: () => {
                window.__shadowPlayerActive = false;
                player.speed = player.baseSpeed;
            },
            activateAI: () => {
                window.__shadowAIActive = true;
                ai.speed = ai.baseSpeed * 1.5;
                skill.ai.duration = 4000;
            },
            deactivateAI: () => {
                window.__shadowAIActive = false;
                ai.speed = ai.baseSpeed;
            }
        },
        phoenix: {
            name: 'í”¼ë‹‰ìŠ¤',
            color: '#ff5722',
            activatePlayer: () => {
                // ê³µì˜ ê¶¤ì ì— ë¶ˆíƒ€ëŠ” íš¨ê³¼ (ì‹œê°ì  + ì†ë„ ëŒ€í­ ì¦ê°€)
                window.__phoenixActive = true;
                ball.speed = ball.speed * 1.8;
                skill.player.duration = 2500;
            },
            deactivatePlayer: () => {
                window.__phoenixActive = false;
                ball.speed = ball.speed / 1.8;
            },
            activateAI: () => {
                window.__phoenixActive = true;
                ball.speed = ball.speed * 1.8;
                skill.ai.duration = 2500;
            },
            deactivateAI: () => {
                window.__phoenixActive = false;
                ball.speed = ball.speed / 1.8;
            }
        }
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
        // ìºë¦­í„° ì„ íƒ
        charCards.forEach(card => {
            card.addEventListener('click', () => {
                const charId = card.dataset.char;
                
                // ì ê¸ˆ ì²´í¬
                if (!characterUnlock.unlocked.includes(charId)) {
                    const required = characterUnlock.requirements[charId];
                    alert(`ì´ ìºë¦­í„°ëŠ” ëˆ„ì  ì ìˆ˜ ${required}ì ì´ í•„ìš”í•©ë‹ˆë‹¤!`);
                    return;
                }
                
                // ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
                charCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedChar = charId;
                // AIëŠ” í•´ê¸ˆëœ ìºë¦­í„° ì¤‘ ëœë¤í•˜ê²Œ ì„ íƒ
                const unlockedChars = characterUnlock.unlocked.filter(id => characters[id]);
                aiChar = unlockedChars[Math.floor(Math.random() * unlockedChars.length)];
                
                player.color = characters[selectedChar].color;
                player.character = selectedChar;
                ai.color = characters[aiChar].color;
                ai.character = aiChar;
                
                startGame();
            });
        });

        // ì¬ì‹œì‘ ë²„íŠ¼
        restartButton.addEventListener('click', () => {
            resetGame();
            gameState = 'menu';
            updateUI();
        });
        
        // ë§ˆìš°ìŠ¤ ì´ë™ìœ¼ë¡œ í”Œë ˆì´ì–´ íŒ¨ë“¤ ì¡°ì¢…
        canvas.addEventListener('mousemove', (e) => {
            if (gameState !== 'playing' && gameState !== 'countdown') return;
            let rect = canvas.getBoundingClientRect();
            playerTargetY = e.clientY - rect.top - player.height / 2;
        });

        // ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ìŠ¤í‚¬ ì‚¬ìš©
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && gameState === 'playing') {
                e.preventDefault();
                activateSkill('player');
            }
        });
    }

    // ìŠ¤í‚¬ í™œì„±í™”
    function activateSkill(who) {
        const now = Date.now();
        const skillData = skill[who];
        
        if (now - skillData.lastUsed > skillData.cooldown && !skillData.isActive) {
            skillData.isActive = true;
            skillData.lastUsed = now;
            
            const char = who === 'player' ? selectedChar : aiChar;
            const activateFunc = who === 'player' ? 'activatePlayer' : 'activateAI';
            const deactivateFunc = who === 'player' ? 'deactivatePlayer' : 'deactivateAI';
            
            characters[char][activateFunc]();
            
            setTimeout(() => {
                skillData.isActive = false;
                characters[char][deactivateFunc]();
            }, skillData.duration);
        }
    }

    // AI ìŠ¤í‚¬ ì‚¬ìš© ë¡œì§
    function aiSkillLogic() {
        const now = Date.now();
        // AIëŠ” ê³µì´ ìì‹  ìª½ìœ¼ë¡œ ë‹¤ê°€ì˜¬ ë•Œ í‹°ì–´ì— ë”°ë¼ ìŠ¤í‚¬ ì‚¬ìš© í™•ë¥  ì¦ê°€
        if (ball.speedX > 0 && ball.x > canvas.width / 2) {
            if (now - skill.ai.lastUsed > skill.ai.cooldown && !skill.ai.isActive) {
                // í‹°ì–´ê°€ ë†’ì„ìˆ˜ë¡ ìŠ¤í‚¬ ì‚¬ìš© í™•ë¥  ì¦ê°€ (ìµœì†Œ 5% ~ ìµœëŒ€ 60%)
                const tier = getCurrentTier();
                const skillChance = Math.min(0.05 + tier * 0.02, 0.6);
                if (Math.random() < skillChance) {
                    activateSkill('ai');
                }
            }
        }
    }

    // AI ë‚œì´ë„ë¥¼ ë­í¬ì— ë”°ë¼ ì¡°ì •
    function adjustAIDifficulty() {
        const tier = getCurrentTier();
        // ì†ë„: 3 -> 7 (ë” ë‚®ê²Œ ì¦ê°€)
        ai.baseSpeed = 3 + (tier * 0.16);
        ai.speed = ai.baseSpeed;
        
        // ë°˜ì‘ì†ë„: 0.02 -> 0.08 (ë” ë‚®ê²Œ ì¦ê°€)
        ai.reactionSpeed = 0.02 + (tier * 0.0025);
    }
    
    // í˜„ì¬ í‹°ì–´ ê³„ì‚°
    function getCurrentTier() {
        for (let i = rankSystem.tierThresholds.length - 1; i >= 0; i--) {
            if (rankSystem.totalScore >= rankSystem.tierThresholds[i]) {
                return i;
            }
        }
        return 0;
    }    // ê²Œì„ ì‹œì‘
    function startGame() {
        gameState = 'playing';
        // í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª©í‘œë¡œ ì„¤ì •
        playerTargetY = player.y;
        updateUI();
        gameLoop();
    }
    
    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    function startCountdown() {
        gameState = 'countdown';
        countdownValue = 3;
        setTimeout(() => {
            countdownValue = 2;
            setTimeout(() => {
                countdownValue = 1;
                setTimeout(() => {
                    resetBall();
                    gameState = 'playing';
                }, 600);
            }, 600);
        }, 600);
    }
    
    // ê²Œì„ ë¦¬ì…‹ (ë¼ìš´ë“œ ë¦¬ì…‹)
    function resetGame() {
        player.score = 0;
        ai.score = 0;
        player.height = 100;
        player.width = 10;
        player.baseHeight = 100;
        player.speed = 8;
        player.baseSpeed = 8;
        ai.height = 100;
        ai.width = 10;
        ai.baseHeight = 100;
        ball.alpha = 1.0;
        ball.radius = 10;
        ball.baseRadius = 10;
        ball.speed = 4.5;
        ball.baseSpeed = 4.5;
        scoreSystem.lastScorer = null;
        skill.player.isActive = false;
        skill.ai.isActive = false;
        skill.player.lastUsed = 0;
        skill.ai.lastUsed = 0;
        // ì„ì‹œ ìƒíƒœ ì´ˆê¸°í™”
        tempState.aiPrevSpeed = null;
        tempState.aiPrevReaction = null;
        tempState.playerPrevSpeed = null;
        tempState.playerPrevReaction = null;
        playerTargetY = player.y;
        
        // íŠ¹ìˆ˜ íš¨ê³¼ í”Œë˜ê·¸ ì´ˆê¸°í™”
        window.__phantomActive = false;
        window.__thunderActive = false;
        window.__shadowPlayerActive = false;
        window.__shadowAIActive = false;
        window.__phoenixActive = false;
        
        // AI ë‚œì´ë„ ì¬ì¡°ì •
        adjustAIDifficulty();
        resetBall();
    }

    // ì ìˆ˜ íšë“ ì‹œ íŒì—… í‘œì‹œ
    function showScorePopup(x, y, points) {
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.style.left = x + 'px';
        popup.style.top = y + 'px';
        popup.textContent = `+${points}`;
        document.getElementById('game-container').appendChild(popup);
        
        setTimeout(() => popup.remove(), 1000);
    }

    // UI ì—…ë°ì´íŠ¸
    // ì½”ì¸ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
    function updateCoinDisplay() {
        const coinAmountEl = document.getElementById('coin-amount');
        if (coinAmountEl) {
            coinAmountEl.textContent = currency.coins;
        }
    }
    
    function updateUI() {
        updateCoinDisplay();
        
        if (gameState === 'menu') {
            uiOverlay.style.display = 'flex';
            charSelectScreen.style.display = 'block';
            gameOverScreen.style.display = 'none';
            updateCharacterCards();
            // ìŠ¤í‚¨ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            const skinsPanel = document.getElementById('skins-panel');
            if (skinsPanel) skinsPanel.style.display = 'none';
        } else if (gameState === 'playing' || gameState === 'countdown') {
            uiOverlay.style.display = 'none';
            // ìŠ¤í‚¨ íŒ¨ë„ í‘œì‹œ
            const skinsPanel = document.getElementById('skins-panel');
            if (skinsPanel) skinsPanel.style.display = 'block';
        } else if (gameState === 'gameOver') {
            uiOverlay.style.display = 'flex';
            charSelectScreen.style.display = 'none';
            gameOverScreen.style.display = 'block';
            // ìŠ¤í‚¨ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            const skinsPanel = document.getElementById('skins-panel');
            if (skinsPanel) skinsPanel.style.display = 'none';
            
            const didWin = player.score > ai.score;
            
            // ë³´ìƒ ì§€ê¸‰ (ìŠ¹ë¦¬/íŒ¨ë°° ëª¨ë‘)
            const reward = didWin ? 50 : 20;
            currency.coins += reward;
            
            // ìºë¦­í„° í•´ê¸ˆ ì²´í¬
            checkCharacterUnlocks();
            
            rankSystem.roundsPlayed++;
            saveCurrency();
            updateCoinDisplay();
            
            const tier = getCurrentTier();
            const currentRank = rankSystem.rankNames[Math.min(tier, rankSystem.rankNames.length - 1)];
            const nextTierScore = tier < rankSystem.tierThresholds.length - 1 ? rankSystem.tierThresholds[tier + 1] : 'ìµœê³  í‹°ì–´';
            
            winnerMessage.textContent = didWin ? "ğŸ‰ ìŠ¹ë¦¬! ğŸ‰" : "ğŸ˜¢ íŒ¨ë°°... ğŸ˜¢";
            document.getElementById('final-score').textContent = `ë¼ìš´ë“œ ì ìˆ˜ - í”Œë ˆì´ì–´: ${player.score} | AI: ${ai.score}`;
            document.getElementById('rank-info').innerHTML = `
                <strong>í˜„ì¬ í‹°ì–´: ${currentRank}</strong><br>
                ëˆ„ì  ì ìˆ˜: ${rankSystem.totalScore} / ${nextTierScore}<br>
                ì½”ì¸ íšë“: +${reward} (ë³´ìœ : ${currency.coins})<br>
                ì´ ë¼ìš´ë“œ: ${rankSystem.roundsPlayed}
            `;
        }
    }
    
    // ê³µ ê·¸ë¦¬ê¸°
    function drawBall() {
        ctx.save();
        ctx.globalAlpha = ball.alpha;
        
        // í”¼ë‹‰ìŠ¤ ìŠ¤í‚¬ í™œì„±í™” ì‹œ ë¶ˆíƒ€ëŠ” íš¨ê³¼
        if (window.__phoenixActive) {
            // í™”ì—¼ ê¶¤ì  ê·¸ë¦¬ê¸°
            for (let i = 0; i < 5; i++) {
                ctx.globalAlpha = ball.alpha * (0.6 - i * 0.1);
                ctx.fillStyle = i % 2 === 0 ? '#ff5722' : '#ffa726';
                ctx.beginPath();
                ctx.arc(
                    ball.x - ball.speedX * i * 0.5,
                    ball.y - ball.speedY * i * 0.5,
                    ball.radius * (1 - i * 0.15),
                    0, Math.PI * 2
                );
                ctx.fill();
            }
            ctx.globalAlpha = ball.alpha;
        }
        
        // ë³¼ ê¸€ë¡œìš°
        const glowScale = window.__skinGlowScale || 1;
        ctx.shadowBlur = 15 * glowScale * (window.__phoenixActive ? 2 : 1);
        ctx.shadowColor = window.__phoenixActive ? '#ff5722' : (characters[selectedChar] ? characters[selectedChar].color : '#eee');
        ctx.fillStyle = window.__phoenixActive ? '#ffeb3b' : ball.color;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }

    // íŒ¨ë“¤ ê·¸ë¦¬ê¸°
    function drawPaddle(x, y, width, height, color) {
        ctx.save();
        // ìŠ¤í‚¬ í™œì„±í™” ì‹œ ìºë¦­í„° ìƒ‰ìƒì˜ ê¸€ë¡œìš°
        const isPlayer = x < canvas.width / 2;
        const who = isPlayer ? 'player' : 'ai';
        const charKey = isPlayer ? selectedChar : aiChar;
        const active = skill[who] && skill[who].isActive;
        
        // ì„€ë„ìš° ìŠ¤í‚¬ íˆ¬ëª…í™” íš¨ê³¼
        if ((isPlayer && window.__shadowPlayerActive) || (!isPlayer && window.__shadowAIActive)) {
            ctx.globalAlpha = 0.3;
        }
        
        if (active && charKey && characters[charKey]) {
            const glowScale = window.__skinGlowScale || 1;
            ctx.shadowBlur = 20 * glowScale;
            ctx.shadowColor = characters[charKey].color;
        }
        ctx.fillStyle = color;
        ctx.fillRect(x, y, width, height);
        ctx.restore();
    }

    // ì ìˆ˜íŒ ê·¸ë¦¬ê¸°
    function drawScores() {
        // ë¼ìš´ë“œ ì ìˆ˜
        ctx.fillStyle = player.color;
        ctx.font = 'bold 48px "Orbitron", "Noto Sans KR", sans-serif';
        ctx.fillText(player.score, canvas.width / 4, 60);
        
        ctx.fillStyle = ai.color;
        ctx.fillText(ai.score, 3 * canvas.width / 4, 60);
        
        // í‹°ì–´ ì •ë³´ í‘œì‹œ (ì¤‘ì•™ ìƒë‹¨)
        ctx.font = '600 16px "Noto Sans KR", sans-serif';
        ctx.fillStyle = '#ffff00';
        ctx.textAlign = 'center';
        const tier = getCurrentTier();
        const currentRank = rankSystem.rankNames[Math.min(tier, rankSystem.rankNames.length - 1)];
        ctx.fillText(currentRank, canvas.width / 2, 30);
        ctx.font = '500 12px "Noto Sans KR", sans-serif';
        ctx.fillText(`ëˆ„ì : ${rankSystem.totalScore} | ì½”ì¸: ${currency.coins}`, canvas.width / 2, 50);
        ctx.textAlign = 'left';
        
        // ìºë¦­í„° ì´ë¦„ í‘œì‹œ
        ctx.font = '500 12px "Noto Sans KR", sans-serif';
        ctx.fillStyle = player.color;
        ctx.fillText(characters[selectedChar].name, 20, canvas.height - 60);
        
        ctx.fillStyle = ai.color;
        ctx.textAlign = 'right';
        ctx.fillText(characters[aiChar].name, canvas.width - 20, canvas.height - 60);
        ctx.textAlign = 'left';
    }

    // ì¤‘ì•™ì„  ê·¸ë¦¬ê¸°
    function drawNet() {
        for (let i = 0; i <= canvas.height; i += 15) {
            drawPaddle(canvas.width / 2 - 1, i, 2, 10, '#333');
        }
    }
    
    // ìŠ¤í‚¬ UI ê·¸ë¦¬ê¸°
    function drawSkillUI() {
    ctx.font = '500 12px "Noto Sans KR", sans-serif';
        const now = Date.now();
        
        // í”Œë ˆì´ì–´ ìŠ¤í‚¬ UI
        const playerCooldownRemaining = Math.max(0, (skill.player.cooldown - (now - skill.player.lastUsed)) / 1000);
        
        if (skill.player.isActive) {
            const durationRemaining = Math.max(0, (skill.player.duration - (now - skill.player.lastUsed)) / 1000);
            ctx.fillStyle = '#0f0';
            ctx.fillText(`ìŠ¤í‚¬ í™œì„±: ${durationRemaining.toFixed(1)}ì´ˆ`, 20, canvas.height - 20);
        } else if (playerCooldownRemaining > 0) {
            ctx.fillStyle = '#f00';
            ctx.fillText(`ì¬ì‚¬ìš©: ${playerCooldownRemaining.toFixed(1)}ì´ˆ`, 20, canvas.height - 20);
        } else {
            ctx.fillStyle = '#0f0';
            ctx.fillText('ìŠ¤í‚¬ ì¤€ë¹„ ì™„ë£Œ [SPACE]', 20, canvas.height - 20);
        }
        
        // AI ìŠ¤í‚¬ UI
        const aiCooldownRemaining = Math.max(0, (skill.ai.cooldown - (now - skill.ai.lastUsed)) / 1000);
        ctx.textAlign = 'right';
        
        if (skill.ai.isActive) {
            const aiDurationRemaining = Math.max(0, (skill.ai.duration - (now - skill.ai.lastUsed)) / 1000);
            ctx.fillStyle = '#0f0';
            ctx.fillText(`AI ìŠ¤í‚¬ í™œì„±: ${aiDurationRemaining.toFixed(1)}ì´ˆ`, canvas.width - 20, canvas.height - 20);
        } else if (aiCooldownRemaining > 0) {
            ctx.fillStyle = '#f00';
            ctx.fillText(`AI ì¬ì‚¬ìš©: ${aiCooldownRemaining.toFixed(1)}ì´ˆ`, canvas.width - 20, canvas.height - 20);
        } else {
            ctx.fillStyle = '#0f0';
            ctx.fillText('AI ìŠ¤í‚¬ ì¤€ë¹„ ì™„ë£Œ', canvas.width - 20, canvas.height - 20);
        }
        
        ctx.textAlign = 'left';
    }

    // ê³µ ìœ„ì¹˜ ë¦¬ì…‹
    function resetBall() {
        ball.x = canvas.width / 2;
        ball.y = canvas.height / 2;
        // ê³µ ì†ë„ ì¶•ì  ì´ˆê¸°í™”
        ball.speed = ball.baseSpeed;
        // ë§ˆì§€ë§‰ì— ì‹¤ì í•œ ìª½ìœ¼ë¡œ ê³µì´ ë‚ ì•„ê°€ë„ë¡
        ball.speedX = -ball.speedX;
        // ì¶• ê¸°ì¤€ ì†ë ¥ ì¬ê³„ì‚° (speedXì˜ ë¶€í˜¸ ìœ ì§€)
        const dir = Math.sign(ball.speedX) || (Math.random() > 0.5 ? 1 : -1);
        const angle = (Math.random() * 0.6 - 0.3); // -0.3 ~ 0.3 ë¼ë””ì•ˆ
        ball.speedX = dir * ball.speed * Math.cos(angle);
        ball.speedY = ball.speed * Math.sin(angle);
    }

    // ì¶©ëŒ ê°ì§€
    function collision(b, p) { // ball, paddle
        return b.x + b.radius > p.x &&
               b.x - b.radius < p.x + p.width &&
               b.y + b.radius > p.y &&
               b.y - b.radius < p.y + p.height;
    }

    // ê²Œì„ ë¡œì§ ì—…ë°ì´íŠ¸
    function update() {
    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì—ëŠ” ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
    if (gameState === 'countdown') {
        return;
    }
    
    // ê³µ ì´ë™ (íŒ¬í…€ í™œì„±í™” ì‹œ ì•½ê°„ì˜ ì›Œë¸” ì¶”ê°€, ì¬ë” í™œì„±í™” ì‹œ ì§€ê·¸ì¬ê·¸)
    if (window.__phantomActive) {
        ball.x += ball.speedX + (Math.random() - 0.5) * 0.8;
        ball.y += ball.speedY + (Math.random() - 0.5) * 0.8;
    } else if (window.__thunderActive) {
        // ì§€ê·¸ì¬ê·¸ íš¨ê³¼
        ball.x += ball.speedX;
        ball.y += ball.speedY + Math.sin(ball.x * 0.1) * 2;
    } else {
        ball.x += ball.speedX;
        ball.y += ball.speedY;
    }

    // í”Œë ˆì´ì–´ íŒ¨ë“¤ ì´ë™: ëª©í‘œ ìœ„ì¹˜ë¡œ ì†ë„ ì œí•œ ì´ë™
    const dy = playerTargetY - player.y;
    const step = Math.max(-player.speed, Math.min(player.speed, dy));
    player.y += step;
    if (player.y < 0) player.y = 0;
    if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;

        // AI íŒ¨ë“¤ ì´ë™ (ë­í¬ ê¸°ë°˜ ë‚œì´ë„)
    // íŒ¬í…€ í˜¼ë€: ê³µì´ ë§¤ìš° ì•ˆë³´ì¼ ë•ŒëŠ” ë°˜ì‘ê°ì†Œ ë° ë…¸ì´ì¦ˆ ì¶”ê°€
    const phantomConfused = ball.alpha <= 0.12; // ê±°ì˜ ì•ˆë³´ì´ëŠ” ìƒíƒœë¡œ ê°„ì£¼
    const reactionFactor = phantomConfused ? ai.reactionSpeed * 0.5 : ai.reactionSpeed;
    const noise = (Math.random() - 0.5) * (phantomConfused ? 20 : 8); // í”½ì…€ ë‹¨ìœ„ ì˜¤ì°¨
    let aiDy = (ball.y + noise - (ai.y + ai.height / 2)) * reactionFactor;
    // ì†ë„ ìº¡ ì ìš©
    aiDy = Math.max(-ai.speed, Math.min(ai.speed, aiDy));
    ai.y += aiDy;
        if (ai.y < 0) ai.y = 0;
        if (ai.y + ai.height > canvas.height) ai.y = canvas.height - ai.height;
        
        // AI ìŠ¤í‚¬ ì‚¬ìš© ë¡œì§
        aiSkillLogic();

        // ë²½ ì¶©ëŒ (ìƒí•˜)
        if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) {
            ball.speedY = -ball.speedY;
        }

        // íŒ¨ë“¤ ì¶©ëŒ
        let currentPaddle = (ball.x < canvas.width / 2) ? player : ai;
        if (collision(ball, currentPaddle)) {
            // ê³µì´ íŒ¨ë“¤ ì–´ë””ì— ë§ì•˜ëŠ”ì§€ ê³„ì‚° (-1: top, 0: middle, 1: bottom)
            let collidePoint = (ball.y - (currentPaddle.y + currentPaddle.height / 2)) / (currentPaddle.height / 2);
            
            // ì¶©ëŒ ê°ë„ ê³„ì‚°
            let angleRad = (Math.PI / 4) * collidePoint;
            
            // ê³µì˜ ë°©í–¥ ì „í™˜ ë° ì†ë„ ì¦ê°€
            let direction = (ball.x < canvas.width / 2) ? 1 : -1;
            ball.speedX = direction * ball.speed * Math.cos(angleRad);
            ball.speedY = ball.speed * Math.sin(angleRad);
            ball.speed = Math.min(ball.speed + 0.2, 9); // ìµœëŒ€ ì†ë„ ì œí•œ (ëŠë¦¬ê²Œ)
        }

        // ì ìˆ˜ íšë“
        if (ball.x - ball.radius < 0) {
            // AI ë“ì 
            ai.score += 1;
            scoreSystem.lastScorer = 'ai';
            showScorePopup(canvas.width * 0.75, canvas.height / 2, 1);
            startCountdown();
        } else if (ball.x + ball.radius > canvas.width) {
            // í”Œë ˆì´ì–´ ë“ì 
            player.score += 1;
            rankSystem.totalScore += 1;
            currency.coins += 5;
            scoreSystem.lastScorer = 'player';
            showScorePopup(canvas.width * 0.25, canvas.height / 2, 1);
            startCountdown();
        }

        // ë¼ìš´ë“œ ì¢…ë£Œ ì¡°ê±´ í™•ì¸
        if (player.score >= POINTS_TO_WIN || ai.score >= POINTS_TO_WIN) {
            gameState = 'gameOver';
            updateUI();
        }
    }

    // ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function render() {
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ìš”ì†Œ ê·¸ë¦¬ê¸°
        drawNet();
        drawScores();
        drawPaddle(player.x, player.y, player.width, player.height, player.color);
        drawPaddle(ai.x, ai.y, ai.width, ai.height, ai.color);
        drawBall();
        drawSkillUI();
        
        // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
        if (gameState === 'countdown') {
            ctx.save();
            ctx.font = 'bold 80px "Orbitron", sans-serif';
            ctx.fillStyle = '#ffff00';
            ctx.textAlign = 'center';
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ffff00';
            ctx.fillText(countdownValue, canvas.width / 2, canvas.height / 2 + 30);
            ctx.restore();
        }
    }

    // ë©”ì¸ ê²Œì„ ë£¨í”„
    function gameLoop() {
        if (gameState === 'playing' || gameState === 'countdown') {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
    }
    
    // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
    function showGachaScreen() {
        document.getElementById('character-select-screen').style.display = 'none';
        document.getElementById('gacha-screen').style.display = 'block';
        document.getElementById('gacha-coin-display').textContent = currency.coins;
    }
    
    function hideGachaScreen() {
        document.getElementById('gacha-screen').style.display = 'none';
        document.getElementById('character-select-screen').style.display = 'block';
    }
    
    function showSkinScreen() {
        document.getElementById('character-select-screen').style.display = 'none';
        document.getElementById('skin-screen').style.display = 'block';
        renderSkinList();
    }
    
    function hideSkinScreen() {
        document.getElementById('skin-screen').style.display = 'none';
        document.getElementById('character-select-screen').style.display = 'block';
    }
    
    // ê°€ì±  í™”ë©´ì—ì„œ ê°€ì±  ìˆ˜í–‰
    function performGachaFromScreen() {
        gachaOnce();
        document.getElementById('gacha-coin-display').textContent = currency.coins;
    }
    
    // ìŠ¤í‚¨ ëª©ë¡ ë Œë”ë§ (ì¥ì°© í™”ë©´ìš©)
    function renderSkinList() {
        const container = document.getElementById('skin-list-container');
        if (!container) return;
        
        if (!skins.owned || skins.owned.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; font-size: 18px;">ë³´ìœ í•œ ìŠ¤í‚¨ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê°€ì± ë¥¼ í†µí•´ ìŠ¤í‚¨ì„ íšë“í•˜ì„¸ìš”!</p>';
            return;
        }
        
        const rarityColors = {
            common: '#9e9e9e',
            rare: '#4dabf7',
            epic: '#9775fa',
            legendary: '#ffd43b'
        };
        
        const rarityNames = {
            common: 'ì»¤ë¨¼',
            rare: 'ë ˆì–´',
            epic: 'ì—í”½',
            legendary: 'ë ˆì „ë”ë¦¬'
        };
        
        // ì¤‘ë³µ ì œê±°í•˜ê³  ê°œìˆ˜ ì„¸ê¸°
        const skinCounts = {};
        skins.owned.forEach(id => {
            skinCounts[id] = (skinCounts[id] || 0) + 1;
        });
        
        const uniqueSkins = Object.keys(skinCounts);
        
        container.innerHTML = uniqueSkins.map(id => {
            const skin = skins.pool.find(s => s.id === id);
            if (!skin) return '';
            
            const isEquipped = skins.equipped === id;
            const count = skinCounts[id];
            const color = rarityColors[skin.rarity];
            
            return `
                <div onclick="equipSkin('${id}')" style="
                    background: ${isEquipped ? 'rgba(0,255,255,0.15)' : 'rgba(20,20,40,0.8)'};
                    border: 3px solid ${isEquipped ? '#00ffff' : color};
                    border-radius: 10px;
                    padding: 20px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: ${isEquipped ? '0 0 20px rgba(0,255,255,0.4)' : 'none'};
                " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 20px rgba(0,255,255,0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='${isEquipped ? '0 0 20px rgba(0,255,255,0.4)' : 'none'}';">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #fff;">${skin.name}</div>
                    <div style="background: ${color}; color: ${skin.rarity === 'common' || skin.rarity === 'rare' || skin.rarity === 'legendary' ? '#000' : '#fff'}; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 10px;">
                        ${rarityNames[skin.rarity].toUpperCase()}
                    </div>
                    ${count > 1 ? `<div style="color: #ffd700; font-size: 14px; margin-top: 5px;">ë³´ìœ : ${count}ê°œ</div>` : ''}
                    ${isEquipped ? '<div style="color: #00ffff; font-size: 16px; font-weight: bold; margin-top: 10px;">âœ“ ì¥ì°©ì¤‘</div>' : '<div style="color: #999; font-size: 14px; margin-top: 10px;">í´ë¦­í•˜ì—¬ ì¥ì°©</div>'}
                </div>
            `;
        }).join('');
    }
    
    // ìŠ¤í‚¨ ì¥ì°©
    function equipSkin(skinId) {
        skins.equipped = skinId;
        saveSkins();
        applyEquippedSkin();
        renderSkinList();
        // ì„±ê³µ í”¼ë“œë°±
        const feedback = document.createElement('div');
        feedback.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,255,255,0.95);
            color: #000;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10001;
            animation: fadeIn 0.3s;
        `;
        const skinName = skins.pool.find(s => s.id === skinId)?.name || 'ìŠ¤í‚¨';
        feedback.textContent = `âœ“ ${skinName} ì¥ì°© ì™„ë£Œ!`;
        document.body.appendChild(feedback);
        setTimeout(() => {
            feedback.style.animation = 'fadeOut 0.3s';
            setTimeout(() => feedback.remove(), 300);
        }, 1500);
    }

    // ì´ˆê¸°í™”
    setupEventListeners();
    loadCurrency();
    loadSkins();
    updateCoinDisplay();
    updateUI();

</script>
</body>
</html>
